# ============================
# 1️⃣ Base dependencies stage
# ============================
FROM node:20.19.5-alpine AS deps

WORKDIR /app

# Copy package files first for caching
COPY package*.json ./

# Install only production dependencies directly (skip dev deps)
RUN --mount=type=cache,target=/root/.npm \
    npm install --omit=dev && npm cache clean --force


# ============================
# 2️⃣ Build stage
# ============================
FROM node:20.19.5-alpine AS builder

WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy source and config files
COPY package*.json ./
COPY tsconfig*.json ./
COPY prisma ./prisma
COPY src ./src

# Optimize Prisma binary for Cloud Run (Alpine-based)
ENV PRISMA_CLI_BINARY_TARGETS="linux-musl"

# Generate Prisma client
RUN --mount=type=cache,target=/root/.npm \
    npx prisma generate

# Build NestJS application
RUN npm run build && npm cache clean --force


# ============================
# 3️⃣ Production stage
# ============================
FROM node:20.19.5-alpine AS production

# Security & environment setup
ENV NODE_ENV=production
WORKDIR /app

# Install Doppler CLI (for runtime secrets)
RUN apk add --no-cache ca-certificates wget && \
    wget -q https://cli.doppler.com/install.sh -O install.sh && \
    sh install.sh && \
    rm -rf install.sh

# Copy production node_modules and build output
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/prisma ./prisma

# Copy startup script
COPY start.sh ./start.sh
RUN chmod +x ./start.sh

# Create non-root user for security
RUN adduser -D -g '' nestjs
USER nestjs

# Expose application port
EXPOSE 3000

# Start the app
ENTRYPOINT ["./start.sh"]
