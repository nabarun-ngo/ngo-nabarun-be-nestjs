// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

generator prismaClassGenerator {
    provider = "prisma-class-generator"
    output   = "../generated/prisma/classes"
    dryRun = false
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model UserProfile {
  id          String    @id
  title       String?   @db.VarChar(5)
  firstName   String    @db.VarChar(50)
  middleName  String?   @db.VarChar(50)
  lastName    String    @db.VarChar(50)
  dateOfBirth DateTime?
  gender      String?   @db.VarChar(10)
  about       String?   @db.VarChar(200)
  picture     String?

  // Relations
  roles            UserRole[]
  phoneNumbers     PhoneNumber[]
  addresses        Address[]
  socialMediaLinks Link[]
  taskAssignments  TaskAssignment[]
  tasks            WorkflowTask[]

  email              String    @unique @db.VarChar(100)
  isPublic           Boolean?
  authUserId         String?   @db.VarChar(100)
  status             String    @db.VarChar(20)
  isTemporary        Boolean
  isSameAddress      Boolean?
  loginMethods       String?   @db.VarChar(20)
  panNumber          String?   @db.VarChar(20)
  aadharNumber       String?   @db.VarChar(20)
  donationPauseStart DateTime?
  donationPauseEnd   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  version   BigInt    @default(0)
  deletedAt DateTime?

  initiatedWorkflows WorkflowInstance[] @relation("InitiatedBy")
  receivedWorkflows  WorkflowInstance[] @relation("InitiatedFor")

  @@index([email])
  @@index([authUserId])
  @@map("user_profiles")
}

model UserRole {
  id           String @id
  roleCode     String @db.VarChar(20)
  roleName     String @db.VarChar(50)
  authRoleCode String @db.VarChar(20)

  // Relation to UserProfile (UserEntity in JPA)
  user   UserProfile @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime  @default(now())
  createdBy String?   @db.VarChar(255)
  expireAt  DateTime?
  version   BigInt    @default(0)

  @@map("user_roles")
}

model PhoneNumber {
  id          String  @id @default(uuid())
  phoneCode   String?
  phoneNumber String?
  hidden      Boolean @default(false)
  primary     Boolean @default(false)

  user   UserProfile @relation(fields: [userId], references: [id])
  userId String

  version BigInt @default(0)

  @@map("phone_numbers")
}

model Link {
  id        String @id @default(uuid())
  linkName  String @db.VarChar(20)
  linkType  String @db.VarChar(20)
  linkValue String @db.Text

  // Relation to UserProfile (UserEntity in JPA)
  user   UserProfile? @relation(fields: [userId], references: [id])
  userId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   BigInt   @default(0)

  @@map("links")
}

model Address {
  id           String      @id @default(uuid())
  addressLine1 String?
  addressLine2 String?
  addressLine3 String?
  hometown     String?
  zipCode      String?
  state        String?
  district     String?
  country      String?
  addressType  String
  // Relation to UserProfile (UserEntity in JPA)
  user         UserProfile @relation(fields: [userId], references: [id])
  userId       String

  version BigInt @default(0)

  @@map("addresses")
}

model OAuthToken {
  id           String    @id @default(uuid())
  provider     String    @db.VarChar(20) // e.g., 'google', 'gmail'
  clientId     String    @db.VarChar(100) // OAuth client ID
  email        String    @db.VarChar(100) // Gmail address associated with token
  accessToken  String    @db.Text // Encrypted access token
  refreshToken String?   @db.Text // Encrypted refresh token
  tokenType    String?   @db.VarChar(20) // Usually 'Bearer'
  expiresAt    DateTime? // Token expiration time
  scope        String?   @db.Text // OAuth scopes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email, clientId])
  @@map("oauth_tokens")
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(20)
  apiKey      String    @db.Text
  apiKeyId    String    @unique @db.VarChar(50)
  permissions String    @db.Text
  rateLimit   BigInt?   @db.BigInt()
  expiresAt   DateTime?
  lastUsedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([apiKeyId])
  @@map("api_keys")
}

model WorkflowInstance {
  id            String  @id @default(uuid())
  name          String
  type          String  @db.VarChar(50)
  description   String  @db.Text
  status        String  @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED
  currentStepId String? @db.VarChar(100)

  initiatedBy   UserProfile? @relation(name: "InitiatedBy", fields: [initiatedById], references: [id])
  initiatedById String?

  initiatedFor   UserProfile? @relation(name: "InitiatedFor", fields: [initiatedForId], references: [id])
  initiatedForId String?

  completedAt DateTime?
  remarks     String?   @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   BigInt   @default(0)

  steps WorkflowStep[]

  @@index([type, status])
  @@index([status])
  @@index([initiatedForId])
  @@map("workflow_instances")
}

model WorkflowStep {
  id              String           @id @default(uuid())
  instanceId      String
  instance        WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  stepId          String           @db.VarChar(50) // Step ID from definition
  name            String           @db.VarChar(200)
  description     String?          @db.Text
  status          String           @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED, FAILED, SKIPPED
  orderIndex      Int
  onSuccessStepId String?          @db.VarChar(50)
  onFailureStepId String?          @db.VarChar(50)
  failureReason   String?          @db.Text
  startedAt       DateTime? // When step was started
  completedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  tasks WorkflowTask[]

  @@index([instanceId])
  @@index([instanceId, orderIndex])
  @@map("workflow_steps")
}

model WorkflowTask {
  id             String       @id @default(uuid())
  stepId         String
  step           WorkflowStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  taskId         String       @db.VarChar(50) // Task ID from definition
  name           String       @db.VarChar(200)
  description    String?      @db.Text
  type           String       @db.VarChar(20) // VERIFICATION, APPROVAL, AUTOMATIC
  status         String       @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED, FAILED, SKIPPED
  handler        String?      @db.VarChar(255) // Handler class name for automatic tasks
  checklist      String?      @db.Text // JSON checklist data
  autoCloseable  Boolean?     @db.Boolean
  autoCloseRefId String?      @db.VarChar(50)
  jobId          String?      @db.VarChar(255) // Job ID if automatic task
  resultData     String?      @db.Text // JSON result data
  completedAt    DateTime?
  completedBy    String?      @db.VarChar(255)
  failureReason  String?      @db.Text
  assignedTo     UserProfile? @relation(fields: [assignedToId], references: [id])
  assignedToId   String       @db.VarChar(255) // User ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assignments TaskAssignment[]

  @@index([stepId])
  @@index([status])
  @@index([jobId])
  @@map("workflow_tasks")
}

model TaskAssignment {
  id           String       @id @default(uuid())
  taskId       String
  task         WorkflowTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignedTo   UserProfile  @relation(fields: [assignedToId], references: [id])
  assignedToId String       @db.VarChar(255) // User ID
  roleName     String?      @db.VarChar(50) // Role name if assigned by role
  assignedBy   String?      @db.VarChar(255)
  status       String       @db.VarChar(20) // PENDING, ACCEPTED, REJECTED, COMPLETED
  acceptedAt   DateTime?
  completedAt  DateTime?
  notes        String?      @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([assignedToId, status])
  @@map("task_assignments")
}
